# Element-ui源码学习系列二——build:file

以下是设计编译打包的命令，下面让我们顺藤摸瓜挨个分析每个命令的作用

```shell
"build:file": "node build/bin/iconInit.js & node build/bin/build-entry.js & node build/bin/i18n.js & node build/bin/version.js"
```

**1.icon图标初始化  node build/bin/iconInit.js**

`该命令主要作用承接样式表代码与官方文档之间联系的作用，当我们在样式表中添加新的字体时，只需重新编译文件就可以自动更新官网文档`

(1).首先通过fs.readFileSync读取'../../packages/theme-chalk/src/'下的icon.scss文件，所有支持的字体icon样式都在该文件中。

```javascript
var fontFile = fs.readFileSync(path.resolve(__dirname, '../../packages/theme-chalk/src/icon.scss'), 'utf8');

// icon.scss
// .el-icon-info:before { content: "\e61a"; } "\e61a"为注册的字体
// .el-icon-error:before { content: "\e62c"; }
```

(2).通过postcss解析后，得到classList，通过正则捕获el-icon-(xxx):before中的内容

```javascript
var classList = [];
var reg = new RegExp(/\.el-icon-([^:]+):before/);
var arr = selector.match(reg);

if (arr && arr[1]) {
	classList.push(arr[1]); //arr[1]为第一个捕获组
}
```

(3).生成'../../examples/icon.json' 文件

```javascript
fs.writeFile(path.resolve(__dirname, '../../examples/icon.json'), JSON.stringify(classList), () => {});

// icon.json
// ["info","error","success","warning",......]
```

(4).在'../../examples/docs/icon.md'中调用icon.json文件，生成网页文档

```vue
</script>
var iconList = require('examples/icon.json');
export default {
  data() {
    return {
      icons: iconList //获取json文件中的数组
    };
  }
}
<script>
<ul class="icon-list">
  <li v-for="name in icons" :key="name"> //遍历数组数据生成所有已配置的icon
    <span>
      <i :class="'el-icon-' + name"></i>
      <span class="icon-name">{{'el-icon-' + name}}</span>
    </span>
  </li>
</ul>
```

**2.编译入口文件  node build/bin/build.entry.js**

`我们在编写产品的时候往往会出现模块非常多，最终发布时需要有一个整合所有文件的模块给别人用，而手动引入模块或修改入口文件非常麻烦。这个命令的作用就是通过json文件的配置生成入口文件`

(1).编写字符串模板

```javascript
// 入口文件导出路径
var OUTPUT_PATH = path.join(__dirname, '../../src/index.js');
// import文件模板
var IMPORT_TEMPLATE = 'import {{name}} from \'../packages/{{package}}/index.js\';';
// 安装组件名称模板
var INSTALL_COMPONENT_TEMPLATE = '  {{name}}';
// 主模板中{{ inclue }},{{ install }},{{ version }},{{ list }}为需要替换的模板语法
// {{ include }} 需要替换为 import Row from '../packages/row/index.js';
// {{ install }} 是为需要安装到Vue的组件
// {{ version }} 是当前版本号
// {{ list }} 是最终导出的模块
var MAIN_TEMPLATE = `/* Automatically generated by './build/bin/build-entry.js' */
{{include}} 
import locale from 'element-ui/src/locale';
import CollapseTransition from 'element-ui/src/transitions/collapse-transition';

const components = [
{{install}},
  CollapseTransition
];

。。。

module.exports = {
  version: '{{version}}',
  locale: locale.use,
  i18n: locale.i18n,
  install,
  CollapseTransition,
  Loading,
{{list}}
};`;
```

(2).通过[json-templater](https://www.npmjs.com/package/json-templater) 插件对模板进行编译

```javascript
// render函数会将第二个参数中的key,与{{ mustache }}语法模板一一对应，最终以value值对其替换
var render = require('json-templater/string'); 
// EOL是当前系统下的行尾符的常量。windows下为'\r\n'
var endOfLine = require('os').EOL;
// render模板
var template = render(MAIN_TEMPLATE, {
  // import语法字符串，通过endOfLine进行换行
  include: includeComponentTemplate.join(endOfLine),
  // Vue安装组件字符串,通过,加上endOfLine进行分割
  install: installTemplate.join(',' + endOfLine),
  // 获取版本信息
  version: process.env.VERSION || require('../../package.json').version,
  // 导出模块,通过,加上endOfLine进行分割
  list: listTemplate.join(',' + endOfLine)
});
```

(3).写入文件

```javascript
var OUTPUT_PATH = path.join(__dirname, '../../src/index.js');
fs.writeFileSync(OUTPUT_PATH, template);

// index.js
import Pagination from '../packages/pagination/index.js';
import Dialog from '../packages/dialog/index.js';
...

const components = [
  Pagination,
  Dialog,
  Autocomplete,
  ...
]
module.exports = {
  version: '2.3.6',
  locale: locale.use,
  i18n: locale.i18n,
  install,
  CollapseTransition,
  Loading,
  Pagination,
  Dialog,
  ...
}
...
```

**3.node build/bin/i18n.js**

**4.编译版本信息  node build/bin/version.js**

`该命令主要作用取package.json或者配置环境信息中的版本号，生成version.json,并通过Vue组件读取json文件生成示例页面`

```javascript
var fs = require('fs');
var path = require('path');
// 获取版本信息
var version = process.env.VERSION || require('../../package.json').version;
// 重要版本列表
var content = { '1.4.13': '1.4', '2.0.11': '2.0', '2.1.0': '2.1', '2.2.2': '2.2', '2.3.9': '2.3' };
// 添加当前版本信息
if (!content[version]) content[version] = '2.4';
// 写入文件
fs.writeFileSync(path.resolve(__dirname, '../../examples/versions.json'), JSON.stringify(content));

// versions.json
{"1.4.13":"1.4","2.0.11":"2.0","2.1.0":"2.1","2.2.2":"2.2","2.3.9":"2.3","2.4.3":"2.4"}

// ../examples/components/header.vue
created() {
    const xhr = new XMLHttpRequest();
    xhr.onreadystatechange = _ => {
        if (xhr.readyState === 4 && xhr.status === 200) {
            const versions = JSON.parse(xhr.responseText);
            //复制对象
            this.versions = Object.keys(versions).reduce((prev, next) => {
                prev[next] = versions[next];
                return prev;
            }, {});
        }
    };
    xhr.open('GET', '/versions.json'); //请求json数据
    xhr.send();
}
```

